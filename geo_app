import os
import tempfile
from pathlib import Path
from typing import Dict, Any, Optional

import streamlit as st
from openai import OpenAI
from pypdf import PdfReader


# ---------------- CONFIG ----------------

MODEL_NAME = "gpt-5.1"  # OpenAI model for geotechnical review


# ---------------- PROMPT ----------------

BUCKEYE_GEOTECH_PROMPT = """
You are a City of Buckeye Building Safety Plans Examiner performing a
GEOTECHNICAL REVIEW for a building project in Arizona.

You are given the text of a geotechnical report (and possibly a short
project description from the reviewer). Use only the information in the
report itself and the project description. Do NOT invent data.

Your tasks:

1) Project & Site Summary
   • Briefly summarize the project type, location (as described in the report),
     and general scope of the geotechnical investigation.
   • Summarize subsurface conditions: soil/rock types, layering, groundwater
     conditions, and any notable geologic hazards (expansive soils, collapsible
     soils, liquefaction potential, flood hazards, etc.).

2) Extract Key Geotechnical Design Parameters
   Extract and clearly list any of the following that are provided in the report.
   Use the exact values and units from the report, or state "Not provided" if
   the report does not give them. If multiple values or ranges are given, list
   them all with context.

   • Soil classification (USCS and/or AASHTO) for each major stratum.
   • Recommended allowable bearing pressures for:
       - spread footings
       - mat foundations (if applicable)
       - drilled piers/caissons (if applicable)
   • Coefficient of subgrade modulus (k-value) for slabs-on-grade and foundations,
     including whether it is for static or dynamic loading, and the assumed
     subgrade improvement (if any).
   • Recommended values for:
       - friction angle (φ) and cohesion (c), if provided
       - lateral earth pressure coefficients (at-rest, active, passive) and any
         corresponding equivalent fluid pressures
       - soil unit weights (total and submerged)
       - estimated total and differential settlement for typical foundation loads
   • Groundwater level(s) and seasonal variation, if discussed.
   • Seismic site class and seismic parameters (e.g., Site Class, Ss, S1,
     Fa, Fv, SDS, SD1) if given, and any references to ASCE 7-22 or IBC 2024.
   • Any special recommendations for slabs-on-grade, pavements, retaining walls,
     shoring, or temporary excavations.
   • Any construction considerations: compaction requirements, fill materials,
     overexcavation depths, moisture conditioning, etc.

   Present these in a clear, structured format (such as a labeled bullet list
   or a simple Markdown table), grouped under headings like:
   "Soil Profile", "Foundation Design Parameters", "Seismic Parameters",
   "Lateral Earth Pressures", "Groundwater", and "Construction Recommendations".

3) Code & Standards Alignment (High-Level)
   Based on the report text, indicate whether the report references current
   design standards such as:
   • 2024 IBC
   • ASCE 7-22
   • ACI 318-19
   • NDS 2024
   • City of Buckeye or other local codes/amendments
   • Any other standards explicitly mentioned in the report

   Do NOT quote code text. Simply list the standards and year as written
   in the report and note any obvious mismatches in code year (for example,
   if the report references an older edition).

4) Registered Professional / Firm Information
   From the report, identify and extract:
   • Name of the geotechnical engineer of record.
   • License type and number, if shown (e.g., P.E., R.G., Geotechnical Engineer).
   • Name of the firm.
   • Signature and seal information (e.g., “signed and sealed”, any dates).
   • Report date and any revision dates.

   Then provide a short "License Verification Notes" section:
   • Confirm whether the report provides enough information (name and license
     number) to verify the geotechnical engineer with the Arizona Board of
     Technical Registration (AZBTR).
   • If name and/or license number are missing or unclear, explicitly flag this
     as a discrepancy.
   • IMPORTANT: You do NOT have direct access to external websites or live
     databases. You must NOT claim that you have actually verified the license.
     Instead, instruct the plan reviewer to confirm the license status using
     the AZBTR online register at the Arizona Board of Technical Registration
     website (https://azbtr.portalus.thentiacloud.net/webs/portal/register/#/).

   Example language:
   “The report lists John Doe, P.E. #12345 as the geotechnical engineer of
    record. The plan reviewer should verify this license in the AZBTR online
    register before approval.”

5) Discrepancy List (Geotechnical-Focused)
   Create a concise list of potential issues or missing items that a City of
   Buckeye reviewer should be aware of. Each item should be one bullet and
   should be clear and actionable. Focus on:
   • Missing or unclear soil classifications or design parameters.
   • Missing or inconsistent allowable bearing pressures or k-values.
   • Missing seismic site class or seismic parameters where they would be
     expected for building design.
   • Conflicting recommendations within the report.
   • Missing information on groundwater, settlement, or lateral pressures when
     those are relevant to the described project.
   • Missing or incomplete registered professional information (name, license
     number, seal, signature, date).

6) Final Summary & Determination
   Provide a short final narrative for the City of Buckeye reviewer:
   • Overall adequacy of the geotechnical report for use in structural and
     foundation design (e.g., “appears adequate”, “appears adequate with
     noted clarifications”, or “additional information recommended”).
   • Any specific follow-up items the reviewer should request from the design
     team or geotechnical engineer.

Formatting requirements:
• Use clear headings and bullet points.
• When listing numeric values, always include units exactly as stated in the
  report (e.g., psf, ksf, pci, pcf, kN/m³).
• Do NOT fabricate any values that are not in the report. If a value is not
  given, explicitly state “Not provided in report.”
"""


# ---------------- HELPERS ----------------

def get_client(api_key: str) -> OpenAI:
    return OpenAI(api_key=api_key)


def extract_pdf_text(pdf_path: str) -> str:
    """
    Extract text from all pages of a PDF.
    """
    reader = PdfReader(pdf_path)
    all_text = []
    for page in reader.pages:
        page_text = page.extract_text() or ""
        all_text.append(page_text)
    return "\n\n".join(all_text)


def run_geotech_review(
    client: OpenAI,
    full_pdf_text: str,
    project_description: Optional[str],
) -> Dict[str, Any]:
    """
    Call the OpenAI model with the geotech prompt and return the review text
    plus any usage information we can get.
    """
    # Truncate very large texts to avoid rate-limit issues
    MAX_CHARS = 80_000
    truncated_text = full_pdf_text
    if len(truncated_text) > MAX_CHARS:
        truncated_text = truncated_text[:MAX_CHARS]
        truncated_text += (
            "\n\n[NOTE TO REVIEWER: Geotechnical report text truncated to the first "
            f"{MAX_CHARS} characters to stay within model rate limits.]"
        )

    if project_description:
        user_content = (
            "PROJECT DESCRIPTION (from reviewer):\n"
            f"{project_description}\n\n"
            "GEOTECHNICAL REPORT TEXT EXTRACT:\n"
            f"{truncated_text}"
        )
    else:
        user_content = (
            "GEOTECHNICAL REPORT TEXT EXTRACT:\n"
            f"{truncated_text}"
        )

    response = client.responses.create(
        model=MODEL_NAME,
        instructions=BUCKEYE_GEOTECH_PROMPT,
        input=user_content,
    )

    review_text = response.output_text

    usage_summary: Dict[str, Any] = {}
    # responses API may expose usage; be defensive
    try:
        u = response.usage  # type: ignore[attr-defined]
        usage_summary = {
            "input_tokens": getattr(u, "input_tokens", None),
            "output_tokens": getattr(u, "output_tokens", None),
            "total_tokens": getattr(u, "total_tokens", None),
        }
    except Exception:
        usage_summary = {}

    return {
        "review_text": review_text,
        "usage": usage_summary,
    }


# ---------------- STREAMLIT UI ----------------

def main(embed: bool = False):
    """
    Geotechnical Review UI.

    embed = False → standalone (run this file directly).
    embed = True  → called from master tabbed app (no page_config).
    """
    if not embed:
        st.set_page_config(
            page_title="City of Buckeye – Geotechnical Review",
            layout="wide",
            initial_sidebar_state="collapsed",
        )

    st.title("City of Buckeye – Geotechnical Review")
    st.caption(f"Model: `{MODEL_NAME}`")

    st.write(
        "Upload a geotechnical report PDF to generate a structured summary of "
        "soil profile, allowable bearing pressures, k-values, seismic site "
        "class, and other key design parameters. The tool also extracts "
        "registered professional information and reminds the reviewer to verify "
        "licenses in the Arizona Board of Technical Registration (AZBTR) online registry."
    )

    st.info(
        "Workflow:\n"
        "1. Upload the geotechnical report PDF.\n"
        "2. Optionally enter a brief project description.\n"
        "3. Run the geotechnical review to generate a structured summary and "
        "geotech-focused discrepancy list."
    )

    # API key from environment only
    env_api_key = os.environ.get("OPENAI_API_KEY", "")
    if not env_api_key:
        st.error(
            "OPENAI_API_KEY is not set in the environment. "
            "Please export it before running the app."
        )
        st.stop()

    client = get_client(env_api_key)

    uploaded_file = st.file_uploader(
        "Upload Geotechnical Report (PDF)",
        type=["pdf"],
        accept_multiple_files=False,
    )

    project_description = st.text_area(
        "Optional project description",
        placeholder=(
            "Example: 2-story Type IIB medical office building; shallow spread "
            "footings and slab-on-grade assumed; no below-grade parking."
        ),
    )

    run_button = st.button("Run Geotechnical Review", type="primary")

    if run_button:
        if not uploaded_file:
            st.error("Please upload a geotechnical report PDF before running the review.")
            st.stop()

        progress_bar = st.progress(0)
        status_placeholder = st.empty()

        progress_bar.progress(5)
        status_placeholder.text("Uploading and preparing geotechnical report...")

        # Save uploaded PDF to a temporary file
        with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmp:
            tmp.write(uploaded_file.read())
            tmp_path = tmp.name

        try:
            progress_bar.progress(25)
            status_placeholder.text("Extracting text from PDF...")

            pdf_text = extract_pdf_text(tmp_path)
            if not pdf_text.strip():
                st.error("No extractable text found in the geotechnical report PDF.")
                return

            progress_bar.progress(50)
            status_placeholder.text("Calling OpenAI model for geotechnical review...")

            result = run_geotech_review(
                client=client,
                full_pdf_text=pdf_text,
                project_description=project_description.strip() or None,
            )

            progress_bar.progress(100)
            status_placeholder.text("Geotechnical review complete.")
        except Exception as e:
            st.error(f"Error during geotechnical review: {e}")
            return
        finally:
            try:
                os.remove(tmp_path)
            except OSError:
                pass

        st.success("Geotechnical review complete.")

        review_text = result.get("review_text", "").strip()
        usage_summary = result.get("usage", {}) or {}

        # Show full AI review
        st.subheader("Geotechnical Review Summary")
        st.text_area(
            "Review output",
            value=review_text,
            height=500,
        )

        # Download as text file
        if review_text:
            base_name = Path(uploaded_file.name).stem
            download_name = f"{base_name}_buckeye_geotech_review.txt"
            st.download_button(
                label="Download Geotechnical Review (.txt)",
                data=review_text.encode("utf-8"),
                file_name=download_name,
                mime="text/plain",
            )

        # Show token usage if available
        if usage_summary:
            st.subheader("Token usage (if reported by API)")
            st.json(usage_summary)

        st.caption(
            "This tool summarizes the geotechnical report for plan review support. "
            "It does not replace the professional judgment of a registered engineer. "
            "License status of the geotechnical engineer of record must be verified "
            "directly in the Arizona Board of Technical Registration online register "
            "(https://azbtr.portalus.thentiacloud.net/webs/portal/register/#/)."
        )


if __name__ == "__main__":
    main()
